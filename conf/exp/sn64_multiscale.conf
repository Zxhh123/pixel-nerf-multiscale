# ============================================================================
# Config for 64x64 images - Enhanced Multi-Scale Fusion with Smart Features
# ============================================================================

include required("../default_mv.conf")

model {
    # ========== 基础配置 ==========
    use_encoder = true
    use_xyz = true
    normalize_z = true
    use_code = true
    use_code_viewdirs = true
    use_viewdirs = true
    use_global_encoder = false

    # ========== 编码器配置 ==========
    encoder {
        # 基础设置
        backbone = resnet34
        pretrained = true
        num_layers = 4

        # ✅ 多尺度特征提取
        use_multi_scale = true

        # 特征处理
        index_interp = bilinear
        index_padding = border
        upsample_interp = bilinear
        feature_scale = 1.0

        # ResNet 配置
        use_first_pool = false  # 保持高分辨率特征
        norm_type = batch

        # ✅ 多尺度输出维度（自动计算）
        # ResNet34: [64, 64, 128, 256] -> 总计 512
    }

    # ========== ✅ 智能特征融合配置 ==========
    use_smart_fusion = true
    fusion_type = attention  # 选项: attention, weighted, adaptive
    fusion_heads = 8  # 注意力头数（仅 attention 模式）
    fusion_dropout = 0.1  # Dropout 率
    use_cbam = true  # 使用 CBAM 注意力增强

    # ========== ✅ 自适应特征采样配置 ==========
    use_adaptive_sampling = true
    quality_threshold = 0.3  # 质量阈值（0-1）

    # ========== MLP 配置 ==========
    mlp_coarse {
        type = resnet  # 使用 ResNet 风格的 MLP
        n_blocks = 5
        d_hidden = 512
        combine_layer = 3
        combine_type = average
        use_spade = false
    }

    mlp_fine {
        type = resnet
        n_blocks = 5
        d_hidden = 512
        combine_layer = 3
        combine_type = average
        use_spade = false
    }

    # ========== 位置编码配置 ==========
    code {
        num_freqs = 6
        include_input = true
    }

    code_viewdirs {
        num_freqs = 4
        include_input = true
    }
}

# ========== 渲染器配置 ==========
renderer {
    n_coarse = 64
    n_fine = 32
    n_fine_depth = 16
    depth_std = 1.0
    sched = []
    white_bkgd = true
    lindisp = false
    hard_alpha_cap = false
}

# ========== 数据配置 ==========
data {
    format = srn
    num_workers = 0  # ✅ 增加数据加载线程

    # 数据增强（可选）
    # augment = true
    # augment_brightness = 0.1
    # augment_contrast = 0.1
}

# ========== 训练配置 ==========
train {
    # 基础训练参数
    epochs = 100
    batch_size = 4  # 根据 GPU 内存调整

    # 学习率配置
    lr = 5e-4
    lr_policy = step
    lr_decay_epochs = 50
    lr_decay_factor = 0.5
    weight_decay = 0.0

    # 优化器配置
    optimizer = adam
    beta1 = 0.9
    beta2 = 0.999

    # 打印和保存间隔
    print_interval = 10
    save_interval = 1  # ✅ 每 1 个 epoch 保存一次
    vis_interval = 10
    eval_interval = 10  # ✅ 每 10 个 epoch 验证一次

    # 梯度累积
    accu_grad = 1
    num_epoch_repeats = 1

    # ✅ 混合精度训练
    use_amp = true

    # ✅ 梯度裁剪
    check_gradients = true
    grad_clip = 1.0
}

# ========== 损失配置 ==========
loss {
    # RGB 损失权重
    lambda_coarse = 1.0
    lambda_fine = 1.0

    # Coarse 损失
    rgb {
        type = l2  # 选项: l1, l2, smooth_l1
    }

    # Fine 损失（可以使用不同的损失函数）
    rgb_fine {
        type = l2
    }
}

# ========== 验证配置 ==========
val {
    num_vis = 5  # 可视化的样本数量
}
